name: Content Type Regression (Phase A)

on:
  workflow_dispatch:

jobs:
  regression-test:
    runs-on: [self-hosted, macOS, preprod]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show Python
        run: |
          which python3 || true
          python3 --version
          python3 -m pip --version || true

      - name: Install dependencies
        run: |
          set -e
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt || true
          python3 -m pip install pytest requests pytest-html

      - name: Run Pytest (generate reports)
        run: |
          set -e
          mkdir -p reports
          python3 -m pytest -v -s tests -k "not content_type" \
            --junitxml=reports/junit.xml \
            --html=reports/report.html --self-contained-html

      - name: List reports (debug)
        if: always()
        run: |
          echo "===== reports tree ====="
          find reports -maxdepth 3 -type f | sort || true
          echo "===== ls -la reports ====="
          ls -la reports || true

      # --------- Zip Evidence ทั้งหมดใน reports/ ---------
      - name: Zip evidence (reports)
        if: always()
        run: |
          set -e
          rm -f reports/evidence.zip || true
          # zip ทั้งโฟลเดอร์ reports (รวม DMPREC-xxxx logs/json + junit + html)
          (cd reports && zip -r evidence.zip .)
          ls -la reports/evidence.zip

      # --------- Import JUnit เข้า Xray ---------
      - name: Import JUnit to Xray
        if: always()
        env:
          XRAY_CLIENT_ID: ${{ secrets.XRAY_CLIENT_ID }}
          XRAY_CLIENT_SECRET: ${{ secrets.XRAY_CLIENT_SECRET }}
          XRAY_PROJECT_KEY: ${{ secrets.XRAY_PROJECT_KEY }}
        run: |
          set -euo pipefail

          if [ ! -f reports/junit.xml ]; then
            echo "ERROR: reports/junit.xml not found"
            ls -la reports || true
            exit 1
          fi

          if [ -z "${XRAY_CLIENT_ID:-}" ] || [ -z "${XRAY_CLIENT_SECRET:-}" ] || [ -z "${XRAY_PROJECT_KEY:-}" ]; then
            echo "ERROR: Missing XRAY secrets."
            exit 1
          fi

          XRAY_PROJECT_KEY="$(echo "$XRAY_PROJECT_KEY" | tr -d '\r\n' | xargs)"

          echo "Authenticate Xray..."
          TOKEN=$(curl -sS -H "Content-Type: application/json" \
            -X POST https://xray.cloud.getxray.app/api/v2/authenticate \
            -d "{\"client_id\":\"$XRAY_CLIENT_ID\",\"client_secret\":\"$XRAY_CLIENT_SECRET\"}" | tr -d '"')

          if [ -z "$TOKEN" ]; then
            echo "ERROR: Xray token is empty"
            exit 1
          fi

          URL="https://xray.cloud.getxray.app/api/v2/import/execution/junit?projectKey=$XRAY_PROJECT_KEY"
          echo "Import URL: $URL"

          curl -sS --fail-with-body \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: text/xml" \
            --data-binary @reports/junit.xml \
            "$URL" \
            > reports/xray_import_response.json

          echo "Xray response:"
          cat reports/xray_import_response.json

      # --------- Attach evidence เข้า Jira (Test Execution issue) ---------
      - name: Attach evidence (HTML + ZIP) to Jira Test Execution
        if: always()
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          set -euo pipefail

          JIRA_BASE_URL="$(echo "${JIRA_BASE_URL:-}" | tr -d '\r\n' | xargs)"
          JIRA_BASE_URL="${JIRA_BASE_URL%/}"

          if [ -z "$JIRA_BASE_URL" ]; then
            echo "ERROR: JIRA_BASE_URL is empty"
            exit 1
          fi

          if [ ! -f "reports/xray_import_response.json" ]; then
            echo "ERROR: reports/xray_import_response.json not found"
            ls -la reports || true
            exit 1
          fi

          TEST_EXEC_KEY="$(python3 -c "import json; print(json.load(open('reports/xray_import_response.json','r',encoding='utf-8')).get('key',''))" | tr -d '\r\n' | xargs)"
          if [ -z "$TEST_EXEC_KEY" ]; then
            echo "ERROR: Cannot find Test Execution KEY in xray_import_response.json"
            cat reports/xray_import_response.json || true
            exit 1
          fi
          echo "Test Execution key: $TEST_EXEC_KEY"

          # verify auth
          curl -sS --fail-with-body \
            -u "$JIRA_EMAIL:$JIRA_API_TOKEN" \
            -H "Accept: application/json" \
            "$JIRA_BASE_URL/rest/api/3/myself" >/dev/null

          ATTACH_URL="$JIRA_BASE_URL/rest/api/3/issue/$TEST_EXEC_KEY/attachments"
          echo "Attach URL: $ATTACH_URL"

          # แนบ report.html + evidence.zip (+junit.xml ถ้าต้องการ)
          for f in reports/report.html reports/evidence.zip reports/junit.xml; do
            if [ -f "$f" ]; then
              echo "Uploading $f ..."
              curl -sS --fail-with-body \
                -u "$JIRA_EMAIL:$JIRA_API_TOKEN" \
                -H "X-Atlassian-Token: no-check" \
                -F "file=@$f" \
                "$ATTACH_URL" >/dev/null
            else
              echo "WARN: missing file $f"
            fi
          done

          echo "DONE attach files to $TEST_EXEC_KEY"

      # --------- Upload artifact เผื่อโหลดจาก Actions ---------
      - name: Upload reports as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reports
          path: reports
