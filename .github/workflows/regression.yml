name: Content Type Regression

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  schedule:
    - cron: "0 2 * * *"

jobs:
  regression-test:
    runs-on: [self-hosted, macOS, preprod]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------
      # DEBUG NETWORK (สำคัญมาก)
      # -----------------------------
      - name: Debug DNS / Network
        run: |
          echo "== Resolve internal host =="

          python3 -c "import socket; host='ai-universal-service-new.preprod-gcp-ai-bn.int-ai-platform.gcp.dmp.true.th'; print('resolved:', host, '->', socket.gethostbyname(host))"

          echo "== Curl internal host =="
          curl -I --max-time 5 http://ai-universal-service-new.preprod-gcp-ai-bn.int-ai-platform.gcp.dmp.true.th || true

      # -----------------------------
      # PYTHON SETUP
      # -----------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install pytest requests pytest-html

      # -----------------------------
      # RUN TEST
      # -----------------------------
      - name: Run Pytest Regression
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          mkdir -p reports
          pytest -v -s tests \
            --junitxml=reports/junit.xml \
            --html=reports/report.html --self-contained-html
        continue-on-error: true

      # -----------------------------
      # SEND RESULT TO XRAY
      # -----------------------------
      - name: Import JUnit to Xray
        if: always()
        env:
          XRAY_CLIENT_ID: ${{ secrets.XRAY_CLIENT_ID }}
          XRAY_CLIENT_SECRET: ${{ secrets.XRAY_CLIENT_SECRET }}
          XRAY_PROJECT_KEY: ${{ secrets.XRAY_PROJECT_KEY }}
        run: |
          set -euo pipefail

          if [ ! -f reports/junit.xml ]; then
            echo "ERROR: junit.xml not found"
            exit 1
          fi

          echo "Authenticate Xray..."
          TOKEN=$(curl -s -H "Content-Type: application/json" \
            -X POST https://xray.cloud.getxray.app/api/v2/authenticate \
            -d "{\"client_id\":\"$XRAY_CLIENT_ID\",\"client_secret\":\"$XRAY_CLIENT_SECRET\"}" | tr -d '"')

          if [ -z "$TOKEN" ]; then
            echo "ERROR: Xray token empty"
            exit 1
          fi

          echo "Import execution to Xray..."
          curl -s -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: text/xml" \
            --data-binary @reports/junit.xml \
            "https://xray.cloud.getxray.app/api/v2/import/execution/junit?projectKey=$XRAY_PROJECT_KEY" \
            > reports/xray_import_response.json

          echo "Xray response:"
          cat reports/xray_import_response.json

      # -----------------------------
