name: Content Type Regression (Phase A)

on:
  workflow_dispatch:

jobs:
  regression-test:
    runs-on: [self-hosted, macOS, preprod]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show Python
        run: |
          which python3 || true
          python3 --version
          python3 -m pip --version || true

      - name: Install dependencies
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install -r requirements.txt || true
          python3 -m pip install pytest requests pytest-html
          python3 -m pip show pytest
          python3 -m pytest --version


      - name: Run Pytest (generate reports)
        run: |
          mkdir -p reports
          python3 -m pytest -v -s tests \
            --junitxml=reports/junit.xml \
            --html=reports/report.html --self-contained-html


      - name: List reports
        if: always()
        run: |
          ls -la reports || true

      - name: Import JUnit to Xray
        if: always()
        env:
          XRAY_CLIENT_ID: ${{ secrets.XRAY_CLIENT_ID }}
          XRAY_CLIENT_SECRET: ${{ secrets.XRAY_CLIENT_SECRET }}
          XRAY_PROJECT_KEY: ${{ secrets.XRAY_PROJECT_KEY }}
        run: |
          set -euo pipefail

          if [ ! -f reports/junit.xml ]; then
            echo "ERROR: reports/junit.xml not found"
            ls -la reports || true
            exit 1
          fi

          # ---- Validate secrets (สำคัญมาก) ----
          if [ -z "${XRAY_CLIENT_ID:-}" ] || [ -z "${XRAY_CLIENT_SECRET:-}" ] || [ -z "${XRAY_PROJECT_KEY:-}" ]; then
            echo "ERROR: Missing XRAY secrets. Please set XRAY_CLIENT_ID, XRAY_CLIENT_SECRET, XRAY_PROJECT_KEY in GitHub Secrets."
            exit 1
          fi

          # Trim spaces/newlines just in case
          XRAY_PROJECT_KEY="$(echo "$XRAY_PROJECT_KEY" | tr -d '\r\n' | xargs)"

          echo "Authenticate Xray..."
          TOKEN=$(curl -sS -H "Content-Type: application/json" \
            -X POST https://xray.cloud.getxray.app/api/v2/authenticate \
            -d "{\"client_id\":\"$XRAY_CLIENT_ID\",\"client_secret\":\"$XRAY_CLIENT_SECRET\"}" | tr -d '"')

          if [ -z "$TOKEN" ]; then
            echo "ERROR: Xray token is empty"
            exit 1
          fi

          URL="https://xray.cloud.getxray.app/api/v2/import/execution/junit?projectKey=$XRAY_PROJECT_KEY"
          echo "Import URL: $URL"

          echo "Import JUnit to Xray..."
          curl -sS -v --fail-with-body \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: text/xml" \
            --data-binary @reports/junit.xml \
            "$URL" \
            > reports/xray_import_response.json

          echo "Xray response:"
          cat reports/xray_import_response.json

