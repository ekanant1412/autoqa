name: Content Type Regression (Phase A)

on:
  workflow_dispatch:

jobs:
  regression-test:
    runs-on: [self-hosted, macOS, preprod]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show Python
        run: |
          set -e
          which python3 || true
          python3 --version
          python3 -m pip --version || true

      - name: Install dependencies
        run: |
          set -e
          python3 -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            python3 -m pip install -r requirements.txt
          fi
          # ensure plugins exist
          python3 -m pip install pytest requests pytest-html
          python3 -m pytest --version

      - name: Preflight check Universal API (infra guard)
        run: |
          echo "Checking universal API availability..."

          STATUS=$(curl -s -o response.json -w "%{http_code}" \
            "http://ai-universal-service-711.preprod-gcp-ai-bn.int-ai-platform.gcp.dmp.true.th/api/v1/universal/sfv-p7?shelfId=Kaw6MLVzPWmo&limit=1")

          echo "HTTP STATUS=$STATUS"
          cat response.json || true

          # ถ้า API ล่ม → skip test (ไม่ fail workflow)
          if [ "$STATUS" != "200" ]; then
            echo "⚠ Universal API not ready — skipping tests"
            exit 0
          fi

          # ตรวจว่ามี data จริงไหม (ไม่ใช่ error payload)
          if ! grep -q '"data"' response.json; then
            echo "⚠ API returned error payload — skipping tests"
            exit 0
          fi

          echo "✅ Universal API OK"


      - name: Run Pytest (generate reports)
        run: |
          set -e
          mkdir -p reports
          python3 -m pytest -v -s tests \
            --junitxml=reports/junit.xml \
            --html=reports/report.html --self-contained-html

      - name: List reports
        if: always()
        run: |
          ls -la reports || true

      - name: Authenticate Xray + Import JUnit
        if: always()
        env:
          XRAY_CLIENT_ID: ${{ secrets.XRAY_CLIENT_ID }}
          XRAY_CLIENT_SECRET: ${{ secrets.XRAY_CLIENT_SECRET }}
          XRAY_PROJECT_KEY: ${{ secrets.XRAY_PROJECT_KEY }}
        run: |
          set -euo pipefail

          if [ ! -f reports/junit.xml ]; then
            echo "ERROR: reports/junit.xml not found"
            ls -la reports || true
            exit 1
          fi

          if [ -z "${XRAY_CLIENT_ID:-}" ] || [ -z "${XRAY_CLIENT_SECRET:-}" ] || [ -z "${XRAY_PROJECT_KEY:-}" ]; then
            echo "ERROR: Missing XRAY secrets. Please set XRAY_CLIENT_ID, XRAY_CLIENT_SECRET, XRAY_PROJECT_KEY."
            exit 1
          fi

          XRAY_PROJECT_KEY="$(echo "$XRAY_PROJECT_KEY" | tr -d '\r\n' | xargs)"

          echo "Authenticate Xray..."
          TOKEN="$(curl -sS -H "Content-Type: application/json" \
            -X POST https://xray.cloud.getxray.app/api/v2/authenticate \
            -d "{\"client_id\":\"$XRAY_CLIENT_ID\",\"client_secret\":\"$XRAY_CLIENT_SECRET\"}" | tr -d '"')"

          if [ -z "$TOKEN" ]; then
            echo "ERROR: Xray token is empty"
            exit 1
          fi

          IMPORT_URL="https://xray.cloud.getxray.app/api/v2/import/execution/junit?projectKey=$XRAY_PROJECT_KEY"
          echo "Import URL: $IMPORT_URL"

          echo "Import JUnit to Xray..."
          curl -sS --fail-with-body \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: text/xml" \
            --data-binary @reports/junit.xml \
            "$IMPORT_URL" \
            > reports/xray_import_response.json

          echo "Saved reports/xray_import_response.json"
          cat reports/xray_import_response.json

      - name: Attach HTML report to Jira Test Execution
        if: always()
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          set -euo pipefail

          if [ ! -f reports/xray_import_response.json ]; then
            echo "WARN: reports/xray_import_response.json not found -> skip attach"
            exit 0
          fi

          if [ ! -f reports/report.html ]; then
            echo "WARN: reports/report.html not found -> skip attach"
            ls -la reports || true
            exit 0
          fi

          JIRA_BASE_URL="$(echo "${JIRA_BASE_URL:-}" | tr -d '\r\n' | xargs)"
          JIRA_BASE_URL="${JIRA_BASE_URL%/}"

          if [ -z "${JIRA_EMAIL:-}" ] || [ -z "${JIRA_API_TOKEN:-}" ] || [ -z "$JIRA_BASE_URL" ]; then
            echo "ERROR: Missing JIRA secrets. Please set JIRA_BASE_URL, JIRA_EMAIL, JIRA_API_TOKEN."
            exit 1
          fi

          TEST_EXEC_KEY="$(python3 -c "import json; print(json.load(open('reports/xray_import_response.json','r',encoding='utf-8')).get('key',''))" | tr -d '\r\n' | xargs)"

          if [ -z "$TEST_EXEC_KEY" ]; then
            echo "ERROR: Cannot find Test Execution KEY in reports/xray_import_response.json"
            cat reports/xray_import_response.json || true
            exit 1
          fi

          echo "Test Execution key: $TEST_EXEC_KEY"

          echo "Verify Jira auth (/myself)..."
          curl -sS --fail-with-body \
            -u "$JIRA_EMAIL:$JIRA_API_TOKEN" \
            -H "Accept: application/json" \
            "$JIRA_BASE_URL/rest/api/3/myself" >/dev/null

          ATTACH_URL="$JIRA_BASE_URL/rest/api/3/issue/$TEST_EXEC_KEY/attachments"
          echo "Attach URL: $ATTACH_URL"

          curl -sS --fail-with-body \
            -u "$JIRA_EMAIL:$JIRA_API_TOKEN" \
            -H "X-Atlassian-Token: no-check" \
            -F "file=@reports/report.html" \
            "$ATTACH_URL"

          echo "✅ Attached reports/report.html to $TEST_EXEC_KEY"
